generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = "file:./dev.db"
}

enum MatchStatus {
  PENDING
  ACCEPTED
  REJECTED
}

enum AppointmentStatus {
  CONFIRMED
  COMPLETED
  CANCELED
  NO_SHOW
}

enum ReportStatus {
  OPEN
  RESOLVED
  REJECTED
}

enum SanctionLevel {
  WARNING
  SUSPEND_7D
  SUSPEND_30D
  BAN
}

model User {
  id            String   @id @default(cuid())
  email         String   @unique
  provider      String
  nickname      String
  bio           String?
  region        String?
  trustScore    Int      @default(50)
  phoneVerified Boolean  @default(false)
  blocked       Boolean  @default(false)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  interests     UserInterest[]
  availability  AvailabilitySlot[]
  proposer      MatchProposal[] @relation("proposer")
  partner       MatchProposal[] @relation("partner")
  appointmentsA Appointment[] @relation("userA")
  appointmentsB Appointment[] @relation("userB")
  checks        AttendanceCheck[]
  reports       Report[] @relation("reporter")
  sanctions     Sanction[]
  reviewsGiven  Review[] @relation("reviewer")
  reviewsRecv   Review[] @relation("reviewee")
}

model UserInterest {
  id     String @id @default(cuid())
  userId String
  name   String

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, name])
}

model AvailabilitySlot {
  id        String   @id @default(cuid())
  userId    String
  weekday   Int
  startTime String
  endTime   String
  area      String
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model MatchProposal {
  id         String      @id @default(cuid())
  proposerId String
  partnerId  String
  message    String?
  status     MatchStatus @default(PENDING)
  createdAt  DateTime    @default(now())

  proposer User @relation("proposer", fields: [proposerId], references: [id], onDelete: Cascade)
  partner  User @relation("partner", fields: [partnerId], references: [id], onDelete: Cascade)

  appointment Appointment?
}

model Appointment {
  id          String            @id @default(cuid())
  proposalId  String            @unique
  userAId     String
  userBId     String
  place       String
  startsAt    DateTime
  status      AppointmentStatus @default(CONFIRMED)
  checkinCode String
  createdAt   DateTime          @default(now())

  proposal MatchProposal @relation(fields: [proposalId], references: [id], onDelete: Cascade)
  userA    User          @relation("userA", fields: [userAId], references: [id], onDelete: Cascade)
  userB    User          @relation("userB", fields: [userBId], references: [id], onDelete: Cascade)

  checks  AttendanceCheck[]
  reports Report[]
  reviews Review[]
}

model AttendanceCheck {
  id            String   @id @default(cuid())
  appointmentId String
  userId        String
  method        String
  checkedAt     DateTime @default(now())

  appointment Appointment @relation(fields: [appointmentId], references: [id], onDelete: Cascade)
  user        User        @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([appointmentId, userId])
}

model Report {
  id            String       @id @default(cuid())
  appointmentId String
  reporterId    String
  targetUserId  String
  reason        String
  evidence      String?
  status        ReportStatus @default(OPEN)
  createdAt     DateTime     @default(now())

  appointment Appointment @relation(fields: [appointmentId], references: [id], onDelete: Cascade)
  reporter    User        @relation("reporter", fields: [reporterId], references: [id], onDelete: Cascade)
}

model Sanction {
  id        String        @id @default(cuid())
  userId    String
  level     SanctionLevel
  reason    String
  startAt   DateTime      @default(now())
  endAt     DateTime?
  createdAt DateTime      @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model Review {
  id            String   @id @default(cuid())
  appointmentId String
  reviewerId    String
  revieweeId    String
  comment       String
  scoreDelta    Int      @default(1)
  createdAt     DateTime @default(now())

  appointment Appointment @relation(fields: [appointmentId], references: [id], onDelete: Cascade)
  reviewer    User        @relation("reviewer", fields: [reviewerId], references: [id], onDelete: Cascade)
  reviewee    User        @relation("reviewee", fields: [revieweeId], references: [id], onDelete: Cascade)

  @@unique([appointmentId, reviewerId])
}
